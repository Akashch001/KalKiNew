<!DOCTYPE html>
<html ng-app="kalkiMailerApp">
<head>
    <title>KalKi Bulk Mailer</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: "Courier New", Courier, monospace;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin-right: 15px;
            filter: drop-shadow(0 0 5px #00ff00);
        }
        h1 {
            color: #00ff00;
            margin: 0;
            font-size: 28px;
            text-shadow: 0 0 10px #00ff00;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #a100ff;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #a100ff;
            transition: all 0.3s ease;
        }
        .tab.active {
            border-bottom: 3px solid #00ff00;
            color: #00ff00;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ffffff;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
            color: #ffffff;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #00ff00;
            outline: none;
        }
        button {
            background-color: #00ff00;
            color: #1a1a1a;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #a100ff;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #003300;
            color: #00ff00;
        }
        .error {
            background-color: #330000;
            color: #ff0000;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #555;
            padding: 8px;
            text-align: left;
            color: #ffffff;
        }
        th {
            background-color: #333;
        }
        .pdf-preview, .html-editor, .pdf-preview-mode, .canvas-panel {
            border: 1px solid #555;
            padding: 10px;
            margin-top: 10px;
            min-height: 200px;
            background-color: #222;
        }
        .html-editor {
            contenteditable: true;
        }
        .pdf-preview-mode {
            background-color: #1a1a1a;
            border: 2px solid #a100ff;
            width: 595px;
            height: 842px;
            overflow: auto;
            box-shadow: 0 0 10px rgba(161, 0, 255, 0.5);
            padding: 20px;
            margin: 0 auto;
        }
        .pdf-preview-mode h1, .pdf-preview-mode h2, .pdf-preview-mode p {
            margin: 10px 0;
            color: #ffffff;
        }
        .canvas-panel {
            overflow: auto;
        }
        .mode-toggle {
            margin-bottom: 15px;
        }
        .mode-toggle button {
            margin-right: 10px;
            background-color: #a100ff;
            color: #ffffff;
        }
        .mode-toggle button:hover {
            background-color: #00ff00;
        }
        .editor-toolbar {
            margin-bottom: 10px;
            position: relative;
        }
        .editor-toolbar button {
            padding: 5px 10px;
            font-size: 12px;
            background-color: #a100ff;
            color: #ffffff;
        }
        .editor-toolbar button:hover {
            background-color: #00ff00;
        }
        .color-dropdown {
            display: none;
            position: absolute;
            background-color: #2a2a2a;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            top: 100%;
            left: 0;
        }
        .color-dropdown.active {
            display: block;
        }
        .color-option {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin: 2px;
            cursor: pointer;
            border: 1px solid #ccc;
        }
        .color-picker-label {
            margin-right: 10px;
            font-size: 12px;
            color: #ffffff;
        }
        .placeholder-dropdown {
            position: relative;
            display: inline-block;
            margin-right: 5px;
        }
        .placeholder-dropdown select {
            padding: 5px;
            font-size: 12px;
            background-color: #333;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 5px;
        }
    </style>
</head>
<body ng-controller="MailerController">
    <div class="container">
        <div class="header">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="glitch" x="0" y="0" width="100%" height="100%">
                        <feOffset result="offOut" in="SourceGraphic" dx="2" dy="2"/>
                        <feColorMatrix result="matrixOut" in="offOut" type="matrix" values="1 0 0 0 0
                                                                      0 1 0 0 0
                                                                      0 0 1 0 0
                                                                      0 0 0 1 0"/>
                        <feGaussianBlur result="blurOut" in="matrixOut" stdDeviation="1"/>
                        <feBlend in="SourceGraphic" in2="blurOut" mode="hard-light"/>
                    </filter>
                </defs>
                <g filter="url(#glitch)">
                    <path d="M20 10 L80 10 L80 90 L20 90 Z" fill="#00ff00" stroke="#a100ff" stroke-width="3"/>
                    <path d="M25 15 L75 15 L75 85 L25 85 Z" fill="#a100ff" stroke="#00ff00" stroke-width="2"/>
                    <text x="50" y="60" font-family="Courier New" font-size="40" fill="#ffffff" text-anchor="middle">K</text>
                </g>
            </svg>
            <h1>KalKi Bulk Mailer</h1>
        </div>
        <div class="tabs">
            <div class="tab" ng-class="{active: activeTab === 'send'}" ng-click="setTab('send')">Send Emails</div>
            <div class="tab" ng-class="{active: activeTab === 'env'}" ng-click="setTab('env')">Environment Files</div>
            <div class="tab" ng-class="{active: activeTab === 'smtp'}" ng-click="setTab('smtp')">SMTP Configurations</div>
            <div class="tab" ng-class="{active: activeTab === 'pdf'}" ng-click="setTab('pdf')">PDF Attachments</div>
            <div class="tab" ng-class="{active: activeTab === 'canvas'}" ng-click="setTab('canvas')">Canvas</div>
        </div>

        <!-- Send Emails Tab -->
        <div class="tab-content" ng-class="{active: activeTab === 'send'}">
            <div class="form-group">
                <label for="recipients">Recipient Emails (comma-separated or upload CSV):</label>
                <input type="text" ng-model="email.recipients" id="recipients" placeholder="e.g., user1@example.com, user2@example.com">
                <input type="file" accept=".csv" id="csvUpload" ng-model="csvFile" onchange="angular.element(this).scope().handleCsvUpload(this)">
            </div>
            <div class="form-group">
                <label for="subject">Subject:</label>
                <input type="text" ng-model="email.subject" id="subject" placeholder="e.g., Invoice for [YourPlaceholder]">
                <div class="placeholder-dropdown">
                    <select ng-model="selectedPlaceholder" ng-change="insertPlaceholder('subject')">
                        <option value="" disabled selected>Insert Placeholder</option>
                        <option ng-repeat="placeholder in dynamicPlaceholders" value="{{placeholder}}">{{placeholder}}</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="body">Email Body:</label>
                <textarea ng-model="email.body" id="body" rows="6" placeholder="e.g., Dear [YourPlaceholder], your invoice is ready..."></textarea>
                <div class="placeholder-dropdown">
                    <select ng-model="selectedPlaceholder" ng-change="insertPlaceholder('body')">
                        <option value="" disabled selected>Insert Placeholder</option>
                        <option ng-repeat="placeholder in dynamicPlaceholders" value="{{placeholder}}">{{placeholder}}</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="smtpSelect">Select SMTP Configuration:</label>
                <select ng-model="email.smtp" id="smtpSelect" ng-options="smtp as smtp.name for smtp in smtps" ng-change="updateSmtpSelection()">
                    <option value="" disabled selected placeholder="Select an SMTP configuration">Select an SMTP configuration</option>
                </select>
            </div>
            <div class="form-group" ng-if="pdfAttachments.length > 0">
                <label>Attached PDFs:</label>
                <ul>
                    <li ng-repeat="pdf in pdfAttachments">{{ pdf.name }} <button ng-click="removePdf($index)">Remove</button></li>
                </ul>
            </div>
            <button ng-click="sendEmails()">Send Emails</button>
            <div class="status" ng-class="status.class" ng-if="status.message">
                {{ status.message }}
            </div>
        </div>

        <!-- Environment Files Tab -->
        <div class="tab-content" ng-class="{active: activeTab === 'env'}">
            <div class="form-group">
                <label for="envUpload">Upload .env File:</label>
                <input type="file" accept=".env" id="envUpload" ng-model="envFile" onchange="angular.element(this).scope().handleEnvUpload(this)" placeholder="Select .env file(s)">
            </div>
            <table ng-if="envFiles.length > 0">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Content Preview</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="env in envFiles">
                        <td>{{ env.name }}</td>
                        <td>{{ env.content | limitTo: 50 }}...</td>
                        <td><button ng-click="removeEnv($index)">Remove</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- SMTP Configurations Tab -->
        <div class="tab-content" ng-class="{active: activeTab === 'smtp'}">
            <div class="form-group">
                <label>1. SMTP Name:</label>
                <input type="text" ng-model="newSmtp.name" id="smtpName" placeholder="e.g., Gmail SMTP" required>
            </div>
            <div class="form-group">
                <label>2. Email ID:</label>
                <input type="text" ng-model="newSmtp.fromEmail" id="smtpFromEmail" placeholder="e.g., sender@example.com" required>
            </div>
            <div class="form-group">
                <label>3. Host:</label>
                <input type="text" ng-model="newSmtp.host" id="smtpHost" placeholder="e.g., smtp.gmail.com" required>
            </div>
            <div class="form-group">
                <label>4. Port:</label>
                <input type="number" ng-model="newSmtp.port" id="smtpPort" placeholder="e.g., 587" required>
            </div>
            <div class="form-group">
                <label>5. Username:</label>
                <input type="text" ng-model="newSmtp.user" id="smtpUser" placeholder="e.g., your-email@gmail.com" required>
            </div>
            <div class="form-group">
                <label>6. Password:</label>
                <input type="password" ng-model="newSmtp.pass" id="smtpPass" placeholder="e.g., your-password" required>
            </div>
            <button ng-click="addSmtp()">Add SMTP</button>
            <table ng-if="smtps.length > 0">
                <thead>
                    <tr>
                        <th>SMTP Name</th>
                        <th>Email ID</th>
                        <th>Host</th>
                        <th>Port</th>
                        <th>Username</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="smtp in smtps">
                        <td>{{ smtp.name }}</td>
                        <td>{{ smtp.fromEmail }}</td>
                        <td>{{ smtp.host }}</td>
                        <td>{{ smtp.port }}</td>
                        <td>{{ smtp.user }}</td>
                        <td><button ng-click="removeSmtp($index)">Remove</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- PDF Attachments Tab -->
        <div class="tab-content" ng-class="{active: activeTab === 'pdf'}">
            <div class="mode-toggle">
                <button ng-click="toggleMode('edit')">Edit Mode</button>
                <button ng-click="toggleMode('preview')">Preview Mode</button>
            </div>
            <div class="editor-toolbar">
                <button ng-click="formatDoc('bold')">B</button>
                <button ng-click="formatDoc('italic')">I</button>
                <button ng-click="formatDoc('underline')">U</button>
                <button ng-click="setFontSize(12)">12px</button>
                <button ng-click="setFontSize(16)">16px</button>
                <button ng-click="setFontSize(20)">20px</button>
                <button ng-click="toggleColorDropdown()" id="colorButton">COLOR</button>
                <div class="color-dropdown" id="colorDropdown" ng-class="{active: isColorDropdownOpen}">
                    <div class="color-picker-label">Page Color:</div>
                    <div class="color-option" style="background-color: #ffffff;" ng-click="setPageColor('#ffffff')"></div>
                    <div class="color-option" style="background-color: #ffffcc;" ng-click="setPageColor('#ffffcc')"></div>
                    <div class="color-option" style="background-color: #ccffcc;" ng-click="setPageColor('#ccffcc')"></div>
                    <div class="color-picker-label">Font Color:</div>
                    <div class="color-option" style="background-color: #000000;" ng-click="setFontColor('#000000')"></div>
                    <div class="color-option" style="background-color: #ff0000;" ng-click="setFontColor('#ff0000')"></div>
                    <div class="color-option" style="background-color: #0000ff;" ng-click="setFontColor('#0000ff')"></div>
                </div>
                <div class="placeholder-dropdown">
                    <select ng-model="selectedPlaceholder" ng-change="insertPlaceholder('editor')">
                        <option value="" disabled selected>Insert Placeholder</option>
                        <option ng-repeat="placeholder in dynamicPlaceholders" value="{{placeholder}}">{{placeholder}}</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>HTML Content for PDF:</label>
                <div class="html-editor" ng-show="mode === 'edit'" contenteditable="true" ng-keyup="updateHtml($event)" id="htmlEditor" style="background-color: {{pageColor}};"></div>
                <div class="pdf-preview-mode" ng-show="mode === 'preview'" ng-bind-html="trustedPdfPreview" style="background-color: {{pageColor}};" ng-if="pdfHtml && trustedPdfPreview"></div>
            </div>
            <button ng-click="generatePdf()">Generate PDF</button>
            <table ng-if="pdfAttachments.length > 0">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="pdf in pdfAttachments">
                        <td>{{ pdf.name }}</td>
                        <td><button ng-click="removePdf($index)">Remove</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Canvas Tab -->
        <div class="tab-content" ng-class="{active: activeTab === 'canvas'}">
            <div class="canvas-panel">
                <h2>Canvas Panel - SMTP Overview</h2>
                <div ng-if="smtps.length > 0">
                    <h3>SMTP Configurations</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>SMTP Name</th>
                                <th>Email ID</th>
                                <th>Host</th>
                                <th>Port</th>
                                <th>Username</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="smtp in smtps">
                                <td>{{ smtp.name }}</td>
                                <td>{{ smtp.fromEmail }}</td>
                                <td>{{ smtp.host }}</td>
                                <td>{{ smtp.port }}</td>
                                <td>{{ smtp.user }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div ng-if="smtps.length === 0">
                    <p>No SMTP configurations added yet.</p>
                </div>
                <h3>Edit PDF HTML</h3>
                <textarea ng-model="pdfHtml" rows="10" placeholder="Edit HTML content for PDF here..." ng-change="updatePreviewFromCanvas()"></textarea>
                <button ng-click="applyHtmlChanges()">Apply Changes</button>
                <div class="pdf-preview-mode" ng-bind-html="trustedPdfPreview" style="background-color: {{pageColor}};" ng-if="pdfHtml && trustedPdfPreview"></div>
            </div>
        </div>
    </div>

    <script>
        angular.module('kalkiMailerApp', [])
            .controller('MailerController', function($scope, $sce, $http) {
                $scope.activeTab = 'send';
                $scope.email = {
                    recipients: '',
                    subject: '',
                    body: '',
                    smtp: null
                };
                $scope.status = {};
                $scope.envFiles = [];
                $scope.smtps = [];
                $scope.newSmtp = {};
                $scope.pdfHtml = '<h1>Sample Heading with [YourPlaceholder]</h1><p>Sample text with [AnotherPlaceholder]...</p>';
                $scope.pdfPreview = $scope.pdfHtml;
                $scope.trustedPdfPreview = $sce.trustAsHtml('<div style="background-color:' + '#ffffff' + ';">' + $scope.pdfHtml + '</div>');
                $scope.pdfAttachments = [];
                $scope.mode = 'edit';
                $scope.pageColor = '#ffffff';
                $scope.fontColor = '#000000';
                $scope.isColorDropdownOpen = false;
                $scope.selectedPlaceholder = '';
                $scope.dynamicPlaceholders = [];
                $scope.recipientPlaceholders = {};

                $scope.setTab = function(tab) {
                    $scope.activeTab = tab;
                    if (tab === 'pdf') {
                        $scope.toggleMode('preview');
                    } else if (tab === 'canvas') {
                        $scope.updateDynamicPlaceholders();
                        $scope.updatePreviewFromCanvas();
                    }
                };

                $scope.updateDynamicPlaceholders = function() {
                    var placeholderRegex = /\[([^\]]+)\]/g;
                    var matches = $scope.pdfHtml.match(placeholderRegex) || [];
                    $scope.dynamicPlaceholders = [...new Set(matches)];
                    console.log('Dynamic placeholders updated at 06:21 PM IST, June 26, 2025:', $scope.dynamicPlaceholders);
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.handleCsvUpload = function(element) {
                    var file = element.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            var text = e.target.result;
                            var rows = text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
                            $scope.recipientPlaceholders = {};
                            rows.forEach(row => {
                                if (row.length >= 2 && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(row[0])) {
                                    var email = row[0];
                                    $scope.recipientPlaceholders[email] = {};
                                    row.slice(1).forEach(value => {
                                        if ($scope.dynamicPlaceholders.includes('[' + value.split('=')[0] + ']')) {
                                            $scope.recipientPlaceholders[email]['[' + value.split('=')[0] + ']'] = value.split('=')[1] || value;
                                        }
                                    });
                                }
                            });
                            $scope.email.recipients = Object.keys($scope.recipientPlaceholders).join(', ');
                            if (!$scope.$$phase) $scope.$apply();
                            $scope.status = {
                                message: 'CSV uploaded: ' + Object.keys($scope.recipientPlaceholders).length + ' recipients with placeholders.',
                                class: 'success'
                            };
                        };
                        reader.readAsText(file);
                    } else {
                        $scope.status = {
                            message: 'Please upload a valid CSV file with email and placeholder values.',
                            class: 'error'
                        };
                        if (!$scope.$$phase) $scope.$apply();
                    }
                    element.value = '';
                };

                $scope.handleEnvUpload = function(element) {
                    var files = element.files;
                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];
                        if (file.name.endsWith('.env')) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                $scope.envFiles.push({ name: file.name, content: e.target.result });
                                $scope.status = { message: 'Uploaded .env file: ' + file.name, class: 'success' };
                                if (!$scope.$$phase) $scope.$apply();
                            };
                            reader.readAsText(file);
                        }
                    }
                    element.value = '';
                };

                $scope.removeEnv = function(index) {
                    $scope.envFiles.splice(index, 1);
                    $scope.status = { message: 'Removed .env file.', class: 'success' };
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.addSmtp = function() {
                    if ($scope.newSmtp.name && $scope.newSmtp.fromEmail && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($scope.newSmtp.fromEmail) &&
                        $scope.newSmtp.host && $scope.newSmtp.port && $scope.newSmtp.user && $scope.newSmtp.pass) {
                        $scope.smtps.push(angular.copy($scope.newSmtp));
                        $scope.newSmtp = {};
                        $scope.status = { message: 'SMTP configuration added successfully at 06:21 PM IST, June 26, 2025.', class: 'success' };
                        if ($scope.smtps.length === 1) $scope.email.smtp = $scope.smtps[0];
                        if (!$scope.$$phase) $scope.$apply();
                    } else {
                        $scope.status = {
                            message: 'Invalid SMTP configuration: Ensure all fields (including a valid Email ID) are filled.',
                            class: 'error'
                        };
                        if (!$scope.$$phase) $scope.$apply();
                    }
                };

                $scope.removeSmtp = function(index) {
                    if ($scope.email.smtp === $scope.smtps[index]) $scope.email.smtp = $scope.smtps.length > 1 ? $scope.smtps[0] : null;
                    $scope.smtps.splice(index, 1);
                    $scope.status = { message: 'SMTP configuration removed.', class: 'success' };
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.updateSmtpSelection = function() {
                    if (!$scope.email.smtp) {
                        $scope.status = { message: 'Please select an SMTP configuration.', class: 'error' };
                    } else {
                        $scope.status = { message: 'Selected SMTP: ' + $scope.email.smtp.name, class: 'success' };
                    }
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.updateHtml = function(event) {
                    var editor = document.getElementById('htmlEditor');
                    if (editor) {
                        $scope.pdfHtml = editor.innerHTML;
                        $scope.updateDynamicPlaceholders();
                        updatePreview();
                    }
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.toggleMode = function(newMode) {
                    $scope.mode = newMode;
                    console.log('Toggling to mode at 06:21 PM IST, June 26, 2025:', newMode, 'pdfHtml:', $scope.pdfHtml);
                    if (newMode === 'preview' && !$scope.pdfHtml.trim()) {
                        $scope.status = { message: 'Please enter HTML content to preview.', class: 'error' };
                    } else if (newMode === 'preview') {
                        updatePreview();
                        console.log('Preview set to:', $scope.trustedPdfPreview);
                    }
                    if (!$scope.$$phase) $scope.$apply();
                };

                function updatePreview() {
                    if ($scope.pdfHtml && $scope.pdfHtml.trim()) {
                        $scope.trustedPdfPreview = $sce.trustAsHtml('<div style="background-color:' + $scope.pageColor + ';">' + $scope.pdfHtml + '</div>');
                    } else {
                        $scope.trustedPdfPreview = $sce.trustAsHtml('<div style="background-color:' + $scope.pageColor + ';">No content to preview</div>');
                    }
                    console.log('Updated preview at 06:21 PM IST, June 26, 2025:', $scope.trustedPdfPreview);
                }

                $scope.toggleColorDropdown = function() {
                    $scope.isColorDropdownOpen = !$scope.isColorDropdownOpen;
                    var dropdown = document.getElementById('colorDropdown');
                    if ($scope.isColorDropdownOpen) dropdown.style.display = 'block';
                    else dropdown.style.display = 'none';
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.formatDoc = function(cmd, value) {
                    document.execCommand(cmd, false, value);
                    var editor = document.getElementById('htmlEditor');
                    $scope.pdfHtml = editor.innerHTML;
                    $scope.updateDynamicPlaceholders();
                    updatePreview();
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.setFontSize = function(size) {
                    document.execCommand('fontSize', false, size / 4);
                    var editor = document.getElementById('htmlEditor');
                    $scope.pdfHtml = editor.innerHTML;
                    $scope.updateDynamicPlaceholders();
                    updatePreview();
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.setPageColor = function(color) {
                    $scope.pageColor = color;
                    var editor = document.getElementById('htmlEditor');
                    editor.style.backgroundColor = color;
                    updatePreview();
                    $scope.isColorDropdownOpen = false;
                    var dropdown = document.getElementById('colorDropdown');
                    dropdown.style.display = 'none';
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.setFontColor = function(color) {
                    document.execCommand('foreColor', false, color);
                    $scope.fontColor = color;
                    var editor = document.getElementById('htmlEditor');
                    $scope.pdfHtml = editor.innerHTML;
                    $scope.updateDynamicPlaceholders();
                    updatePreview();
                    $scope.isColorDropdownOpen = false;
                    var dropdown = document.getElementById('colorDropdown');
                    dropdown.style.display = 'none';
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.insertPlaceholder = function(field) {
                    if ($scope.selectedPlaceholder) {
                        var element, start, end;
                        if (field === 'subject') {
                            element = document.getElementById('subject');
                            start = element.selectionStart;
                            end = element.selectionEnd;
                            $scope.email.subject = $scope.email.subject.substring(0, start) + $scope.selectedPlaceholder + $scope.email.subject.substring(end);
                            element.focus();
                            element.setSelectionRange(start + $scope.selectedPlaceholder.length, start + $scope.selectedPlaceholder.length);
                        } else if (field === 'body') {
                            element = document.getElementById('body');
                            start = element.selectionStart;
                            end = element.selectionEnd;
                            $scope.email.body = $scope.email.body.substring(0, start) + $scope.selectedPlaceholder + $scope.email.body.substring(end);
                            element.focus();
                            element.setSelectionRange(start + $scope.selectedPlaceholder.length, start + $scope.selectedPlaceholder.length);
                        } else if (field === 'editor') {
                            element = document.getElementById('htmlEditor');
                            if (element) {
                                var range = window.getSelection().getRangeAt(0);
                                range.deleteContents();
                                var placeholderNode = document.createTextNode($scope.selectedPlaceholder);
                                range.insertNode(placeholderNode);
                                element.focus();
                            }
                        }
                        $scope.pdfHtml = element ? element.innerHTML : $scope.pdfHtml;
                        $scope.updateDynamicPlaceholders();
                        updatePreview();
                        $scope.selectedPlaceholder = '';
                        if (!$scope.$$phase) $scope.$apply();
                    }
                };

                $scope.generatePdf = function() {
                    if (!$scope.pdfHtml) {
                        $scope.status = { message: 'Please enter HTML content to generate PDF.', class: 'error' };
                        if (!$scope.$$phase) $scope.$apply();
                        return;
                    }
                    var element = document.createElement('div');
                    element.innerHTML = '<div style="background-color:' + $scope.pageColor + ';">' + $scope.pdfHtml + '</div>';
                    html2pdf().from(element).toPdf().get('pdf').then(function(pdf) {
                        var fileName = 'attachment_' + new Date().toISOString().replace(/[:.-]/g, '') + '.pdf';
                        var file = new File([pdf.output('blob')], fileName, { type: 'application/pdf' });
                        $scope.pdfAttachments.push({ name: fileName, file: file });
                        $scope.trustedPdfPreview = $sce.trustAsHtml(element.innerHTML);
                        $scope.status = { message: 'PDF generated: ' + fileName + ' at 06:21 PM IST, June 26, 2025.', class: 'success' };
                        if (!$scope.$$phase) $scope.$apply();
                    }).catch(function(error) {
                        $scope.status = { message: 'Error generating PDF: ' + error.message, class: 'error' };
                        if (!$scope.$$phase) $scope.$apply();
                    });
                };

                $scope.removePdf = function(index) {
                    $scope.pdfAttachments.splice(index, 1);
                    $scope.status = { message: 'PDF attachment removed at 06:21 PM IST, June 26, 2025.', class: 'success' };
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.updatePreviewFromCanvas = function() {
                    updatePreview();
                };

                $scope.applyHtmlChanges = function() {
                    $scope.updateDynamicPlaceholders();
                    updatePreview();
                    $scope.status = { message: 'HTML changes applied at 06:21 PM IST, June 26, 2025.', class: 'success' };
                    if (!$scope.$$phase) $scope.$apply();
                };

                // Send emails using backend function
                $scope.sendEmails = function() {
                    if (!$scope.email.recipients || !$scope.email.subject || !$scope.email.body || !$scope.email.smtp) {
                        $scope.status = { message: 'Please fill in all fields and select an SMTP configuration.', class: 'error' };
                        if (!$scope.$$phase) $scope.$apply();
                        return;
                    }

                    var recipients = $scope.email.recipients.split(',').map(function(email) {
                        return email.trim();
                    }).filter(function(email) {
                        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                    });

                    if (recipients.length === 0) {
                        $scope.status = { message: 'No valid email addresses provided.', class: 'error' };
                        if (!$scope.$$phase) $scope.$apply();
                        return;
                    }

                    $scope.pdfAttachments = []; // Clear previous attachments
                    var baseHtml = $scope.pdfHtml;
                    var fromEmail = $scope.email.smtp.fromEmail;

                    if (!fromEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(fromEmail)) {
                        $scope.status = { message: 'Invalid Email ID in SMTP configuration. Please use a valid email address.', class: 'error' };
                        if (!$scope.$$phase) $scope.$apply();
                        return;
                    }

                    recipients.forEach(function(recipientEmail) {
                        var placeholders = $scope.recipientPlaceholders[recipientEmail] || {};
                        var customizedHtml = baseHtml;
                        $scope.dynamicPlaceholders.forEach(function(placeholder) {
                            var value = placeholders[placeholder] || placeholder.replace('[', '').replace(']', ') + ' Default');
                            customizedHtml = customizedHtml.replace(new RegExp(placeholder, 'g'), value);
                        });

                        var element = document.createElement('div');
                        element.innerHTML = '<div style="background-color:' + $scope.pageColor + ';">' + customizedHtml + '</div>';
                        html2pdf().from(element).toPdf().get('pdf').then(function(pdf) {
                            var uniqueId = Math.random().toString(36).substr(2, 9);
                            var timestamp = new Date().toISOString().replace(/[:.-]/g, ''); // e.g., 202506261821
                            var fileName = 'attachment_' + recipientEmail.replace(/[@.]/g, '_') + '_' + uniqueId + '_' + timestamp + '.pdf';
                            var file = new File([pdf.output('blob')], fileName, { type: 'application/pdf' });
                            $scope.pdfAttachments.push({ name: fileName, file: file });

                            var subjectWithPlaceholders = $scope.email.subject;
                            var bodyWithPlaceholders = $scope.email.body;
                            $scope.dynamicPlaceholders.forEach(function(placeholder) {
                                var value = placeholders[placeholder] || placeholder.replace('[', '').replace(']', ') + ' Default');
                                subjectWithPlaceholders = subjectWithPlaceholders.replace(new RegExp(placeholder, 'g'), value);
                                bodyWithPlaceholders = bodyWithPlaceholders.replace(new RegExp(placeholder, 'g'), value);
                            });

                            // Prepare attachment data
                            var attachment = {
                                content: btoa(new Uint8Array(pdf.output('arraybuffer')).reduce((data, byte) => data + String.fromCharCode(byte), '')),
                                filename: fileName,
                                type: 'application/pdf',
                                disposition: 'attachment'
                            };

                            // Call backend function
                            $http({
                                method: 'POST',
                                url: '/.netlify/functions/send-email',
                                headers: { 'Content-Type': 'application/json' },
                                data: {
                                    to: recipientEmail,
                                    from: fromEmail,
                                    subject: subjectWithPlaceholders,
                                    body: bodyWithPlaceholders,
                                    attachment: attachment
                                }
                            }).then(function(response) {
                                console.log('Email sent successfully to ' + recipientEmail + ' at 06:21 PM IST, June 26, 2025: ' + response.data.message);
                                $scope.status = { message: 'Email sent to ' + recipientEmail + ' successfully.', class: 'success' };
                            }, function(error) {
                                console.error('Failed to send email to ' + recipientEmail + ': ', error.data ? error.data.error : error.statusText);
                                $scope.status = { message: 'Failed to send email to ' + recipientEmail + ': ' + (error.data ? error.data.error : error.statusText) + '. Check SMTP settings.', class: 'error' };
                                if (!$scope.$$phase) $scope.$apply();
                            });
                        }).catch(function(error) {
                            console.error('Error generating PDF for ' + recipientEmail + ' at 06:21 PM IST, June 26, 2025: ' + error.message);
                            $scope.status = { message: 'Error generating PDF for ' + recipientEmail + ': ' + error.message + '. Check console.', class: 'error' };
                            if (!$scope.$$phase) $scope.$apply();
                        });
                    });

                    $scope.status = { message: 'Emails processing for ' + recipients.length + ' recipients at 06:21 PM IST, June 26, 2025. Check console/status.', class: 'success' };
                    if (!$scope.$$phase) $scope.$apply();
                };

                $scope.updatePreviewFromCanvas = function() {
                    updatePreview();
                };

                $scope.applyHtmlChanges = function() {
                    $scope.updateDynamicPlaceholders();
                    updatePreview();
                    $scope.status = { message: 'HTML changes applied at 06:21 PM IST, June 26, 2025.', class: 'success' };
                    if (!$scope.$$phase) $scope.$apply();
                };

                // Ensure DOM is ready before initializing
                angular.element(document).ready(function() {
                    $scope.updateDynamicPlaceholders();
                    updatePreview();
                    console.log('Application initialized at 06:21 PM IST, June 26, 2025');
                });
            });
    </script>
</body>
</html>